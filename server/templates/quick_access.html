<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ·è®¿é—® - Cookie Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .data-section {
            margin-bottom: 25px;
        }
        .data-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .data-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            word-break: break-all;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .encrypted-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .decrypt-section {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .decrypt-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .copy-btn {
            background: #28a745;
            font-size: 12px;
            padding: 5px 10px;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background: #1e7e34;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª Cookie å¿«æ·è®¿é—®</h1>
            <p>Pass ID: {{ pass_id }}</p>
        </div>

        {% if data %}
            {% if data.encrypted %}
                <div class="encrypted-notice">
                    <strong>âš ï¸ æ•°æ®å·²åŠ å¯†</strong><br>
                    æ­¤æ•°æ®ä½¿ç”¨å¯†ç è¿›è¡Œäº†åŠ å¯†ï¼Œéœ€è¦è¾“å…¥æ­£ç¡®çš„å¯†ç æ‰èƒ½æŸ¥çœ‹å†…å®¹ã€‚
                </div>

                <div class="decrypt-section">
                    <div class="data-title">ğŸ”“ è§£å¯†æ•°æ®</div>
                    <input type="password" id="decryptPassword" class="decrypt-input" placeholder="è¯·è¾“å…¥è§£å¯†å¯†ç ">
                    <button class="btn" onclick="decryptData()">è§£å¯†</button>
                    <button class="btn copy-btn" onclick="copyDecryptScript()">å¤åˆ¶è§£å¯†è„šæœ¬</button>
                    <div id="decryptResult"></div>
                </div>

                <div class="data-section">
                    <div class="data-title">ğŸ”’ åŠ å¯†æ•°æ® (Base64)</div>
                    <div class="data-content" id="encryptedData">{{ data.encrypted }}</div>
                </div>
            {% else %}
                {% if data.cookies %}
                    <div class="data-section">
                        <div class="data-title">ğŸª Cookies</div>
                        <div class="data-content">{{ data.cookies | tojson(indent=2) }}</div>
                    </div>
                {% endif %}

                {% if data.localStorage %}
                    <div class="data-section">
                        <div class="data-title">ğŸ’¾ Local Storage</div>
                        <div class="data-content">{{ data.localStorage | tojson(indent=2) }}</div>
                    </div>
                {% endif %}

                {% if data.sessionStorage %}
                    <div class="data-section">
                        <div class="data-title">ğŸ“‹ Session Storage</div>
                        <div class="data-content">{{ data.sessionStorage | tojson(indent=2) }}</div>
                    </div>
                {% endif %}
            {% endif %}

            {% if data.metadata %}
                <div class="data-section">
                    <div class="data-title">ğŸ“Š å…ƒæ•°æ®</div>
                    <div class="data-content">
                        åˆ›å»ºæ—¶é—´: {{ data.metadata.created_at }}<br>
                        åŸŸå: {{ data.metadata.domain }}<br>
                        {% if data.metadata.expires_at %}
                        è¿‡æœŸæ—¶é—´: {{ data.metadata.expires_at }}<br>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="error">
                âŒ æœªæ‰¾åˆ°æ•°æ®æˆ– Pass ID æ— æ•ˆ
            </div>
        {% endif %}

        <div class="footer">
            <p>
                <a href="/api/quick/{{ pass_id }}?format=json" target="_blank">æŸ¥çœ‹ JSON æ ¼å¼</a> |
                <a href="#" onclick="copyJsonApiUrl(); return false;" title="å¤åˆ¶çº¯JSON API URL">ğŸ“‹ å¤åˆ¶çº¯JSON API</a> |
                <a href="#" onclick="openJsonApi(); return false;" title="åœ¨æ–°çª—å£æ‰“å¼€çº¯JSON API">ğŸ”— æ‰“å¼€çº¯JSON API</a> |
                <a href="/docs" target="_blank">API æ–‡æ¡£</a>
            </p>
            <p>Generated by Chrome Cookie Manager</p>
        </div>
    </div>

    <script>
        // AES è§£å¯†å‡½æ•°
        async function aesDecrypt(encryptedData, password) {
            try {
                // å°† Base64 æ•°æ®è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                const encryptedBytes = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
                
                // ä»åŠ å¯†æ•°æ®ä¸­æå– salt å’Œ IV
                const salt = encryptedBytes.slice(8, 16);
                const iv = encryptedBytes.slice(16, 32);
                const ciphertext = encryptedBytes.slice(32);
                
                // ä½¿ç”¨å¯†ç å’Œ salt æ´¾ç”Ÿå¯†é’¥
                const passwordBytes = new TextEncoder().encode(password);
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordBytes,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                // è§£å¯†æ•°æ®
                const decryptedBytes = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    ciphertext
                );
                
                // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶è§£æ JSON
                const decryptedText = new TextDecoder().decode(decryptedBytes);
                return JSON.parse(decryptedText);
            } catch (error) {
                throw new Error('è§£å¯†å¤±è´¥: ' + error.message);
            }
        }

        // è§£å¯†æ•°æ®
        async function decryptData() {
            const password = document.getElementById('decryptPassword').value;
            const encryptedData = document.getElementById('encryptedData').textContent;
            const resultDiv = document.getElementById('decryptResult');
            
            if (!password) {
                resultDiv.innerHTML = '<div class="error">è¯·è¾“å…¥å¯†ç </div>';
                return;
            }
            
            try {
                const decryptedData = await aesDecrypt(encryptedData, password);
                
                let html = '<div class="success">âœ… è§£å¯†æˆåŠŸï¼</div>';
                
                if (decryptedData.cookies) {
                    html += '<div class="data-section"><div class="data-title">ğŸª Cookies</div><div class="data-content">' + 
                           JSON.stringify(decryptedData.cookies, null, 2) + '</div></div>';
                }
                
                if (decryptedData.localStorage) {
                    html += '<div class="data-section"><div class="data-title">ğŸ’¾ Local Storage</div><div class="data-content">' + 
                           JSON.stringify(decryptedData.localStorage, null, 2) + '</div></div>';
                }
                
                if (decryptedData.sessionStorage) {
                    html += '<div class="data-section"><div class="data-title">ğŸ“‹ Session Storage</div><div class="data-content">' + 
                           JSON.stringify(decryptedData.sessionStorage, null, 2) + '</div></div>';
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">' + error.message + '</div>';
            }
        }

        // å¤åˆ¶è§£å¯†è„šæœ¬
        function copyDecryptScript() {
            const script = `// AES è§£å¯†è„šæœ¬ - å¯åœ¨å…¶ä»–é¡µé¢ä½¿ç”¨
async function aesDecrypt(encryptedData, password) {
    try {
        const encryptedBytes = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
        const salt = encryptedBytes.slice(8, 16);
        const iv = encryptedBytes.slice(16, 32);
        const ciphertext = encryptedBytes.slice(32);
        
        const passwordBytes = new TextEncoder().encode(password);
        const keyMaterial = await crypto.subtle.importKey(
            'raw', passwordBytes, { name: 'PBKDF2' }, false, ['deriveBits', 'deriveKey']
        );
        
        const key = await crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
            keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
        );
        
        const decryptedBytes = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv }, key, ciphertext
        );
        
        const decryptedText = new TextDecoder().decode(decryptedBytes);
        return JSON.parse(decryptedText);
    } catch (error) {
        throw new Error('è§£å¯†å¤±è´¥: ' + error.message);
    }
}

// ä½¿ç”¨ç¤ºä¾‹:
// const encryptedData = 'è¿™é‡Œæ˜¯åŠ å¯†çš„Base64æ•°æ®';
// const password = 'ä½ çš„å¯†ç ';
// aesDecrypt(encryptedData, password).then(data => console.log(data));`;
            
            navigator.clipboard.writeText(script).then(() => {
                alert('è§£å¯†è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = script;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('è§£å¯†è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // è·å–å½“å‰é¡µé¢çš„æŸ¥è¯¢å‚æ•°
        function getCurrentQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            return params;
        }

        // æ„å»ºçº¯JSON API URL
        function buildJsonApiUrl() {
            const params = getCurrentQueryParams();
            const baseUrl = window.location.origin + '/api/quick/{{ pass_id }}';
            const queryParams = new URLSearchParams();
            
            // æ·»åŠ domainå‚æ•°ï¼ˆå¿…éœ€ï¼‰
            if (params.domain) {
                queryParams.set('domain', params.domain);
            }
            
            // æ·»åŠ keyå‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (params.key) {
                queryParams.set('key', params.key);
            }
            
            // ä¸æ·»åŠ formatå‚æ•°ï¼Œè¿™æ ·é»˜è®¤è¿”å›JSON
            const queryString = queryParams.toString();
            return queryString ? `${baseUrl}?${queryString}` : baseUrl;
        }

        // å¤åˆ¶çº¯JSON API URL
        function copyJsonApiUrl() {
            const jsonApiUrl = buildJsonApiUrl();
            
            navigator.clipboard.writeText(jsonApiUrl).then(() => {
                alert('çº¯JSON API URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + jsonApiUrl);
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = jsonApiUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('çº¯JSON API URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + jsonApiUrl);
            });
        }

        // æ‰“å¼€çº¯JSON API
        function openJsonApi() {
            const jsonApiUrl = buildJsonApiUrl();
            window.open(jsonApiUrl, '_blank');
        }

        // å›è½¦é”®è§£å¯†
        document.getElementById('decryptPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                decryptData();
            }
        });
    </script>
</body>
</html>